<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyPlan</title>
    <link rel="icon" href="/images/CyPlan_Logo.png">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/styles.css">

    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />

    <!-- Pass Courses and Selected Sections to JavaScript -->
    <script th:inline="javascript">
        var initialData = /*[[${courses}]]*/ [];
        var selectedSections = /*[[${selectedSections}]]*/ [];
    </script>
</head>
<body class="d-flex flex-column min-vh-100">
<header class="header">
    <div class="container d-flex align-items-center">
        <img src="/images/CyPlan_Logo.png" alt="CyPlan Logo" class="logo me-3">
        <div class="CyPlan">
            <span>C</span>
            <span>y</span>
            <span>P</span>
            <span>l</span>
            <span>a</span>
            <span>n</span>
        </div>
    </div>
</header>

<div th:if="${errorMessage}" id="errorMessage" class="alert alert-danger text-center m-0" role="alert"
     style="width: 100%; border-radius: 0;" th:text="${errorMessage}"></div>
<div th:if="${successMessage}" id="successMessage" class="alert alert-success text-center m-0" role="alert"
     style="width: 100%; border-radius: 0;" th:text="${successMessage}"></div>

<div id="app" class="container mt-5 content-wrapper">
    <main>
        <h1 class="mb-4">Welcome to CyPlan!</h1>
        <p>Class planner for ISU students to simplify your schedule planning because workdays make everything difficult.</p>

        <div class="mb-5">
            <form action="/addCourse" method="POST" id="add-course-form">
                <div class="mb-3">
                    <label class="form-label">Department</label>
                    <select name="department" class="form-select" required>
                        <option value="" disabled selected>Select a Department</option>
                        <option th:each="dept : ${departments}" th:value="${dept}" th:text="${dept}"></option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Course ID</label>
                    <input type="text" class="form-control" name="courseId" placeholder="e.g., COMS 2280" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Course</button>
            </form>

            <div class="mt-3">
                <form action="/generateSchedules" method="GET" class="d-inline">
                    <button type="submit" class="btn btn-success">Generate Schedules</button>
                </form>
                <form action="/nextSchedule" method="POST" class="d-inline ms-2">
                    <button type="submit" class="btn btn-primary">Next Schedule</button>
                </form>
            </div>

            <div v-if="courses.length > 0" class="mt-5">
                <h2 class="mb-4">Your Courses</h2>
                <div class="row">
                    <div v-for="(course, courseIndex) in courses" :key="courseIndex" class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h4 class="card-title">{{ course.courseId }}: {{ course.courseName }}</h4>
                                <hr class="line-break">
                                <p class="card-text">{{ course.description }}</p>
                            </div>
                            <div class="card-footer">
                                <button type="button" class="btn btn-secondary" @click="toggleSections(course)">
                                    {{ course.showSections ? 'Hide Sections' : 'Show Sections' }}
                                </button>
                                <ul v-show="course.showSections" class="list-group list-group-flush section-list mt-2">
                                    <li v-for="(section, sectionIndex) in course.sections" :key="sectionIndex" class="list-group-item">
                                        <p>
                                            <strong>Instructor:</strong> {{ section.instructor }}<br>
                                            <strong>Days:</strong> {{ section.daysOfTheWeek }}<br>
                                            <strong>Time:</strong> {{ section.timeStart }} - {{ section.timeEnd }}<br>
                                            <strong>Open Seats:</strong> {{ section.openSeats }}<br>
                                            <strong>Section Number:</strong> {{ section.sectionNumber }}
                                        </p>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div th:if="${courses.size() == 0}" class="mt-4">
                <p>No courses to display. Please add courses using the form above.</p>
            </div>
        </div>

        <div>
            <h1 class="mb-4">Course Schedule</h1>
            <div id='calendar'></div>
        </div>
    </main>
</div>

<footer class="footer mt-auto">
    <div class="container">
        <p class="mb-0">Â© 2024 CyPlan. All rights reserved.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp } = Vue;
    const { Calendar } = FullCalendar;

    createApp({
        data() {
            return {
                courses: initialData,
                sections: selectedSections,
                calendar: null,
            };
        },
        methods: {
            toggleSections(course) {
                if (course.showSections === undefined) {
                    this.$set(course, 'showSections', true);
                } else {
                    course.showSections = !course.showSections;
                }
            },
            initCalendar() {
                const calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                    this.calendar = new Calendar(calendarEl, {
                        initialView: 'timeGridWeek',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: ''
                        },
                        firstDay: 1,
                        hiddenDays: [0, 6],
                        allDaySlot: false,
                        slotMinTime: '06:00:00',
                        slotMaxTime: '22:00:00',
                        events: this.generateEvents(this.sections),
                        eventDisplay: 'block',
                    });
                    this.calendar.render();
                }
            },
            updateCalendar() {
                if (this.calendar) {
                    this.calendar.removeAllEvents();
                    this.calendar.addEventSource(this.generateEvents(this.sections));
                }
            },
            generateEvents(sections) {
                const events = [];
                sections.forEach(section => {
                    const dayIndices = this.convertDaysToIndices(section.daysOfTheWeek);
                    if (section.timeStart === 'N/A' || section.timeEnd === 'N/A') {
                        return;
                    }
                    events.push({
                        title: `${section.courseId} - Section ${section.sectionNumber}`,
                        daysOfWeek: dayIndices,
                        startTime: this.convertTimeFormat(section.timeStart),
                        endTime: this.convertTimeFormat(section.timeEnd),
                        startRecur: '2024-08-21',
                        endRecur: '2024-12-15',
                    });
                });
                return events;
            },
            convertDaysToIndices(dayString) {
                const dayMapping = {
                    'Monday': 1,
                    'Tuesday': 2,
                    'Wednesday': 3,
                    'Thursday': 4,
                    'Friday': 5,
                    'Saturday': 6,
                    'Sunday': 0
                };
                const days = [];
                for (const [dayName, index] of Object.entries(dayMapping)) {
                    if (dayString.includes(dayName)) {
                        days.push(index);
                    }
                }
                return days;
            },
            convertTimeFormat(timeStr) {
                if (!timeStr || timeStr === 'N/A') return null;

                const [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':');

                if (modifier === 'PM' && hours !== '12') {
                    hours = parseInt(hours, 10) + 12;
                }
                if (modifier === 'AM' && hours === '12') {
                    hours = '00';
                }

                hours = String(hours).padStart(2, '0');
                minutes = String(minutes).padStart(2, '0');
                return `${hours}:${minutes}:00`;
            },
        },
        mounted() {
            this.initCalendar();
        },
        watch: {
            sections: {
                handler() {
                    this.updateCalendar();
                },
                deep: true,
            },
        },
    }).mount('#app');
</script>

</body>
</html>

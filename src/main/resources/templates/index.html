<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyPlan</title>
    <link rel="icon" href="/images/CyPlan_Logo.png">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/styles.css">

    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />

    <!-- Pass Courses, Selected Sections, and Departments to JavaScript -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var initialData = /*[[${courses}]]*/ [];
        var selectedSections = /*[[${selectedSections}]]*/ [];
        var departments = /*[[${departments}]]*/ [];
        var currentScheduleIndex = /*[[${currentScheduleIndex}]]*/ 0;
        var scheduleCount = /*[[${scheduleCount}]]*/ 0;
        /*]]>*/
    </script>
</head>
<body class="d-flex flex-column min-vh-100">
<header class="header">
    <div class="container d-flex align-items-center">
        <img src="/images/CyPlan_Logo.png" alt="CyPlan Logo" class="logo me-3">
        <div class="CyPlan">
            <span>C</span>
            <span>y</span>
            <span>P</span>
            <span>l</span>
            <span>a</span>
            <span>n</span>
        </div>
    </div>
</header>

<!-- Vue.js Managed Flash Messages -->
<div v-if="flashMessage.message" :class="['alert', `alert-${flashMessage.type}`, 'text-center', 'm-0']" role="alert"
     style="width: 100%; border-radius: 0;" v-text="flashMessage.message">
</div>

<!-- Vue.js App Root Element -->
<div id="app" class="container mt-5 content-wrapper">
    <main>
        <h1 class="mb-4">Welcome to CyPlan!</h1>
        <p>Class planner for ISU students to simplify your schedule planning because workday makes everything difficult.</p>

        <div class="mb-5">
            <!-- Course Addition Form -->
            <form @submit.prevent="addCourse" id="add-course-form">
                <div class="mb-3">
                    <label class="form-label">Department</label>
                    <select v-model="newCourse.department" class="form-select" required>
                        <option value="" disabled>Select a Department</option>
                        <option v-for="dept in departments" :key="dept" :value="dept">{{ dept }}</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Course ID</label>
                    <input type="text" class="form-control" v-model="newCourse.courseId" placeholder="e.g., COMS 2280" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Course</button>
            </form>

            <!-- Generate Schedules button -->
            <div v-if="courses.length > 0" class="text-center mt-4 mb-4">
                <button @click="generateSchedules" class="btn btn-primary">Generate Schedules</button>
            </div>

            <!-- Schedule Navigation -->
            <transition name="fade">
                <div v-if="scheduleCount > 0" class="schedule-navigation-compact">
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <button @click="previousSchedule" class="btn btn-primary">Previous</button>
                        <span class="schedule-counter">Schedule {{ currentScheduleIndex + 1 }} of {{ scheduleCount }}</span>
                        <button @click="nextSchedule" class="btn btn-primary">Next</button>
                    </div>
                </div>
            </transition>

            <!-- Calendar section -->
            <div class="mt-5">
                <h2 class="mb-4">Course Schedule</h2>
                <div id='calendar'></div>
            </div>

            <!-- List of Added Courses -->
            <div v-if="courses.length > 0" class="mt-5">
                <h2 class="mb-4">Your Courses</h2>
                <div class="row">
                    <div v-for="(course, index) in courses" :key="index" class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h4 class="card-title">{{ course.courseId }}</h4>
                                <hr class="line-break">
                                <p class="card-text">{{ course.description }}</p>

                                <!-- Sections Dropdown -->
                                <div class="sections-container">
                                    <button class="btn btn-outline-primary w-100"
                                            @click="toggleSections(course)">
                                        {{ course.showSections ? 'Hide Sections' : 'View Sections' }}
                                    </button>
                                    <transition name="slide-fade">
                                        <div v-if="course.showSections" class="sections-dropdown mt-3">
                                            <div v-for="(section, sectionIndex) in course.sections"
                                                 :key="sectionIndex"
                                                 class="section-item">
                                                <div class="section-header">
                                                    Section {{ section.sectionNumber }}
                                                </div>
                                                <div class="section-details">
                                                    <div class="detail-row">
                                                        <span class="detail-label">Instructor:</span>
                                                        <span class="detail-value">{{ section.instructor }}</span>
                                                    </div>
                                                    <div class="detail-row">
                                                        <span class="detail-label">Days:</span>
                                                        <span class="detail-value">{{ section.daysOfTheWeek }}</span>
                                                    </div>
                                                    <div class="detail-row">
                                                        <span class="detail-label">Time:</span>
                                                        <span class="detail-value">{{ section.timeStart }} - {{ section.timeEnd }}</span>
                                                    </div>
                                                    <div class="detail-row">
                                                        <span class="detail-label">Open Seats:</span>
                                                        <span class="detail-value">{{ section.openSeats }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </transition>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Display Message if no courses are found -->
            <div v-if="courses.length === 0" class="mt-4">
                <p>No courses to display. Please add courses using the form above.</p>
            </div>
        </div>
    </main>
</div>

<footer class="footer mt-auto">
    <div class="container">
        <p class="mb-0">Â© 2024 CyPlan. All rights reserved.</p>
    </div>
</footer>

<!-- Include Vue.js via CDN -->
<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
<!-- Include FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Vue.js App Script -->
<script>
    const { createApp } = Vue;
    const { Calendar } = FullCalendar;

    createApp({
        data() {
            return {
                departments: departments,
                courses: initialData.map(course => ({
                    ...course,
                    showSections: false,
                    sections: course.sections || []
                })),
                selectedSections: selectedSections,
                newCourse: {
                    department: '',
                    courseId: '',
                },
                flashMessage: {
                    type: '',
                    message: ''
                },
                calendar: null,
                currentScheduleIndex: currentScheduleIndex || 0,
                scheduleCount: scheduleCount || 0,
            };
        },
        methods: {
            toggleSections(course) {
                course.showSections = !course.showSections;
                console.log('Toggling sections for course:', course.courseId);
                console.log('Show sections:', course.showSections);
                console.log('Number of sections:', course.sections.length);
                console.log('Sections:', course.sections);
                this.$forceUpdate();
            },
            addCourse() {
                const formData = new FormData();
                formData.append('department', this.newCourse.department);
                formData.append('courseId', this.newCourse.courseId);

                fetch('/addCourse', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    })
                    .catch(error => {
                        console.error('Error adding course:', error);
                        this.flashMessage.type = 'danger';
                        this.flashMessage.message = 'An error occurred while adding the course.';
                        this.showFlashMessage();
                    });
            },
            generateSchedules() {
                fetch('/generateSchedules')
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    })
                    .catch(error => {
                        console.error('Error generating schedules:', error);
                        this.flashMessage.type = 'danger';
                        this.flashMessage.message = 'Error generating schedules.';
                    });
            },
            nextSchedule() {
                console.log('Switching to next schedule...'); // Debug log
                fetch('/nextSchedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    })
                    .catch(error => {
                        console.error('Error switching to next schedule:', error);
                        this.flashMessage.type = 'danger';
                        this.flashMessage.message = 'Error switching to next schedule.';
                    });
            },
            previousSchedule() {
                console.log('Switching to previous schedule...'); // Debug log
                fetch('/previousSchedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    })
                    .catch(error => {
                        console.error('Error switching to previous schedule:', error);
                        this.flashMessage.type = 'danger';
                        this.flashMessage.message = 'Error switching to previous schedule.';
                    });
            },
            initCalendar() {
                const calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                    this.calendar = new Calendar(calendarEl, {
                        initialView: 'timeGridWeek',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: ''
                        },
                        firstDay: 1, // Monday
                        hiddenDays: [0, 6], // Hide Sunday and Saturday
                        allDaySlot: false,
                        slotMinTime: '06:00:00',
                        slotMaxTime: '22:00:00',
                        events: this.generateEvents(this.selectedSections),
                        eventDisplay: 'block',
                    });
                    this.calendar.render();
                }
            },
            updateCalendar() {
                if (this.calendar) {
                    this.calendar.removeAllEvents();
                    this.calendar.addEventSource(this.generateEvents(this.selectedSections));
                }
            },
            generateEvents(sections) {
                const events = [];
                sections.forEach(section => {
                    const dayIndices = this.convertDaysToIndices(section.daysOfTheWeek);
                    // Skip sections with invalid times
                    if (section.timeStart === 'N/A' || section.timeEnd === 'N/A') {
                        return;
                    }
                    events.push({
                        title: `${section.courseId} - Section ${section.sectionNumber}`,
                        daysOfWeek: dayIndices,
                        startTime: this.convertTimeFormat(section.timeStart),
                        endTime: this.convertTimeFormat(section.timeEnd),
                        startRecur: '2024-08-21', // Adjust to your academic period start date
                        endRecur: '2024-12-15',   // Adjust to your academic period end date
                    });
                });
                return events;
            },
            convertDaysToIndices(dayString) {
                const dayMapping = {
                    'Monday': 1,
                    'Tuesday': 2,
                    'Wednesday': 3,
                    'Thursday': 4,
                    'Friday': 5,
                    'Saturday': 6,
                    'Sunday': 0
                };
                const days = [];
                for (const [dayName, index] of Object.entries(dayMapping)) {
                    if (dayString.includes(dayName)) {
                        days.push(index);
                    }
                }
                return days;
            },
            convertTimeFormat(timeStr) {
                // Handle cases where timeStr might be empty or invalid
                if (!timeStr || timeStr === 'N/A') return null;

                // Convert time from "h:mm A" format to "HH:mm:ss" format
                const [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':');

                if (modifier === 'PM' && hours !== '12') {
                    hours = parseInt(hours, 10) + 12;
                }
                if (modifier === 'AM' && hours === '12') {
                    hours = '00';
                }

                // Pad hours and minutes with leading zeros if necessary
                hours = String(hours).padStart(2, '0');
                minutes = String(minutes).padStart(2, '0');
                return `${hours}:${minutes}:00`;
            },
            showFlashMessage() {
                // Automatically hide the flash message after 5 seconds
                setTimeout(() => {
                    this.flashMessage.message = '';
                }, 5000);
            },
            getCalendarEvents() {
                const events = [];
                for (const section of this.selectedSections) {
                    const days = section.daysOfTheWeek.split(',');
                    for (const day of days) {
                        if (day.trim()) {
                            const event = {
                                title: `${section.courseId}\n${section.instructor}`, // Add instructor name
                                startTime: section.timeStart,
                                endTime: section.timeEnd,
                                daysOfWeek: [this.getDayNumber(day.trim())],
                                backgroundColor: this.getCourseColor(section.courseId),
                                borderColor: this.getCourseColor(section.courseId),
                                extendedProps: {
                                    section: section.sectionNumber,
                                    instructor: section.instructor
                                }
                            };
                            events.push(event);
                        }
                    }
                }
                return events;
            },
            // Add tooltip to show more details
            eventDidMount(info) {
                tippy(info.el, {
                    content: `
                        ${info.event.title}
                        Section: ${info.event.extendedProps.section}
                        Instructor: ${info.event.extendedProps.instructor}
                    `,
                    allowHTML: true
                });
            }
        },
        mounted() {
            console.log('Departments:', this.departments);
            console.log('Courses:', this.courses);
            console.log('Selected Sections:', this.selectedSections);
            console.log('Current schedule index:', this.currentScheduleIndex); // Debug log
            console.log('Schedule count:', this.scheduleCount); // Debug log
            this.initCalendar();
        },
        watch: {
            selectedSections: {
                handler() {
                    this.updateCalendar();
                },
                deep: true,
            },
        },
    }).mount('#app');
</script>

</body>
</html>

